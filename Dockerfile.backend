# ğŸ“ backend/Dockerfile.backend
# =============================
# ğŸ— Ã‰tape 1 : Construction
# =============================
FROM node:20-alpine AS builder

# ğŸ”§ Installation des outils nÃ©cessaires Ã  la compilation
RUN apk add --no-cache \
    python3 \
    make \
    g++ \
    libpq \
    bash \
    file

# â¬†ï¸ Mise Ã  jour de npm
RUN npm install -g npm@latest --force
RUN echo "ğŸ“¦ Version de npm : $(npm --version)"

# ğŸ“ RÃ©pertoire de travail
WORKDIR /app

# ğŸ“¦ Copier les fichiers de dÃ©pendances
COPY package*.json ./

# ğŸ“¥ Installer les dÃ©pendances de production
RUN npm install --production --loglevel=warn

# â• Ajouter Prisma en dev pour le build
RUN npm install --save-dev prisma@latest @prisma/client@latest --force

# ğŸ“ Copier le reste de l'application
COPY . .

# ğŸ§ª Debug temporaire pour valider que le bon server.js est utilisÃ©
RUN echo "ğŸ§ª Contenu de server.js aprÃ¨s COPY :" && head -n 20 server.js

# ğŸ” VÃ©rification de la copie complÃ¨te
RUN echo "ğŸ“‚ Contenu du dossier /app :" && ls -la /app

# âš™ï¸ GÃ©nÃ©rer le client Prisma
RUN npx prisma generate

# ğŸ§¼ Nettoyage du cache npm
RUN npm cache clean --force

# =============================
# ğŸš€ Ã‰tape 2 : Image finale lÃ©gÃ¨re
# =============================
FROM node:20-alpine

# ğŸ“ RÃ©pertoire de travail
WORKDIR /app

# ğŸ“¦ Copier uniquement lâ€™application depuis lâ€™Ã©tape de build
COPY --from=builder /app /app

# ğŸŸ¢ DÃ©finir le port via ENV (sera surchargÃ© dynamiquement Ã  l'exÃ©cution via `.env`)
ARG SERVER_PORT=7001
ENV SERVER_PORT=$SERVER_PORT

# ğŸ“£ Ce port est exposÃ© pour rÃ©fÃ©rence (non obligatoire mais utile pour la doc)
EXPOSE $SERVER_PORT

# ğŸ DÃ©marrer le serveur
CMD ["node", "server.js"]

